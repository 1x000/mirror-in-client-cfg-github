{% extends 'base.html' %}

{# 定义一个宏，用于渲染文件列表 #}
{% macro render_files(files, title) %}
  {% if files %}
    <h3 class="mb-3 mt-4 border-bottom pb-2">{{ title }}</h3>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
      {% for file in files %}
      <div class="col">
        {# 卡片本身不再是链接，以便点击复选框 #}
        <div class="card h-100 shadow-sm card-hover">
          {# 批量选择的复选框 #}
          <div class="position-absolute top-0 end-0 p-2" style="z-index: 10;">
            <input class="form-check-input file-checkbox" type="checkbox" name="file_ids" value="{{ file.id }}" onclick="event.stopPropagation();">
          </div>
          
          {# 链接包裹图片和主体内容 #}
          <a href="{{ url_for('file_detail', file_id=file.id) }}" class="text-decoration-none stretched-link-container">
            {# 卡片顶部图片区域 #}
            <div class="card-img-container">
              {% if file.filename.lower().endswith(('.png','.jpg','.jpeg','.gif','.bmp','.webp')) %}
                <img src="{{ url_for('static', filename='uploads/' + file.filename) }}" class="card-img-top" alt="{{ file.title or file.filename }}">
              {% else %}
                {# 文件图标占位符 #}
                <div class="default-icon-wrapper">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-muted"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                </div>
              {% endif %}
              <div class="position-absolute bottom-0 end-0 m-2">
                <span class="badge rounded-pill bg-dark bg-opacity-75 px-2 py-1">{{ file.filename.split('.')[-1] | upper }}</span>
              </div>
            </div>

            {# 卡片主体内容区域 #}
            <div class="card-body p-3">
              <h6 class="card-title fw-bold text-dark mb-2 text-truncate" title="{{ file.title or file.filename }}">{{ file.title or file.filename }}</h6>
              <p class="card-text small text-muted mb-0 d-flex justify-content-between">
                <span>{{ file.formatted_date }}</span>
                <span class="badge bg-info-soft text-info">下载量: {{ file.download_count | default(0) }}</span>
              </p>
            </div>
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}
{% endmacro %}


{% block top_actions %}
<a href="{{ url_for('index') }}" class="btn btn-link ps-0">
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
  返回首页
</a>
{% endblock %}

{% block content %}
<div class="mb-4 d-flex align-items-center">
  {% if folder.logo_filename %}
    <img src="{{ url_for('static', filename='logos/' + folder.logo_filename) }}" alt="{{ folder.name }} logo" class="me-3 rounded shadow-sm" style="width: 60px; height: 60px; object-fit: cover;">
  {% else %}
    <img src="{{ url_for('placeholder_image', text=folder.name) }}" alt="{{ folder.name }} placeholder" class="me-3 rounded shadow-sm" style="width: 60px; height: 60px; object-fit: cover;">
  {% endif %}
  <div class="flex-grow-1">
    <h2 class="h4">{{ folder.name }}</h2>
    <p class="text-muted mb-0 small">{{ folder.description or '暂无说明' }}</p>
  </div>
</div>
<hr class="mb-4">
<div class="container-fluid">
    <form id="batch-download-form" action="{{ url_for('batch_download') }}" method="post">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="btn-group">
                <a href="{{ url_for('search', query='', folder_id=folder.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-search me-1"></i> 在当前文件夹内搜索
                </a>
                {% if partition_info %}
                <a href="{{ url_for('search', query='', partition_id=partition_info.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-search-plus me-1"></i> 在 "{{ partition_info.name }}" 分区内搜索
                </a>
                {% endif %}
            </div>
        </div>

        {% if admin_files or user_files %}
        <div class="d-flex align-items-center mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                <label class="form-check-label" for="select-all-checkbox">
                    全选
                </label>
            </div>
            <button type="submit" id="batch-download-btn" class="btn btn-success ms-3" disabled>
                <i class="fas fa-download me-1"></i> 打包下载选中文件
            </button>
        </div>
        {% endif %}

        <div class="row">
            {# 管理员上传的文件 #}
            <div class="col-12">
              {{ render_files(admin_files, '官方文件') }}
            </div>

            {# 用户上传的文件 #}
            <div class="col-12">
              {{ render_files(user_files, '社区分享') }}
            </div>

            {% if not admin_files and not user_files %}
            <div class="col-12"><div class="alert alert-secondary text-center">此文件夹中暂无文件</div></div>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}


{% block extra_css %}
{# 为了让卡片样式更好看，可以把这段CSS加到你的 base.html 或者主CSS文件里 #}
<style>
    .card-hover {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .card-img-container {
        width: 100%;
        padding-top: 56.25%; /* 16:9 宽高比，类似视频缩略图 */
        position: relative;
        background-color: #f1f3f5;
        overflow: hidden; /* 隐藏超出部分 */
    }
    .card-img-container .card-img-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover; /* 保证图片填满容器，不变形 */
    }
    .card-img-container .default-icon-wrapper {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .card .stretched-link-container {
        text-decoration: none;
    }
    .card .card-title {
        line-height: 1.4;
    }
    .card .stretched-link-container::after {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
        content: "";
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    const downloadBtn = document.getElementById('batch-download-btn');

    if (!selectAllCheckbox) return;

    function updateDownloadButtonState() {
        const anyChecked = Array.from(fileCheckboxes).some(cb => cb.checked);
        downloadBtn.disabled = !anyChecked;
    }

    selectAllCheckbox.addEventListener('change', function () {
        fileCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateDownloadButtonState();
    });

    fileCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            if (!this.checked) {
                selectAllCheckbox.checked = false;
            } else {
                const allChecked = Array.from(fileCheckboxes).every(cb => cb.checked);
                if (allChecked) {
                    selectAllCheckbox.checked = true;
                }
            }
            updateDownloadButtonState();
        });
    });

    // Initial state check
    updateDownloadButtonState();
});
</script>
{% endblock %}
