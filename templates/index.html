{% extends 'base.html' %}

{% block content %}
<div class="row">
    <!-- 主内容区 -->
    <div class="col-lg-8">

        {# 检查是否有任何文件夹 #}
        {% if all_folders %}

            {# 遍历已按组排序的文件夹列表 #}
            {% for folder in all_folders %}

                {# 当分组名称与上一个循环项不同时（或在第一个循环项时），打印分组标题 #}
                {% if loop.changed(folder.group_name) %}
                    
                    {# 如果不是第一个分组，需要先闭合上一个分组的卡片容器div #}
                    {% if not loop.first %}
                        </div>
                    {% endif %}
                    
                    {# 打印新的分组标题。如果文件夹没有分组(group_name is None)，则显示'未分类' #}
                    <h4 class="mb-3 mt-4"><i class="fas fa-layer-group me-2"></i>{{ folder.group_name or '未分类' }}</h4>
                    
                    {# 为新分组的卡片开启一个新的容器 #}
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                {% endif %}
                
                <!-- 单个文件夹卡片 -->
                <div class="col">
                    <a href="{{ url_for('folder_detail', folder_id=folder.id) }}" class="text-decoration-none">
                        <div class="card h-100 text-center shadow-sm" style="transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-5px)';" onmouseout="this.style.transform='translateY(0)';">
                            <div style="height: 120px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                {% if folder.logo_filename %}
                                <img src="{{ url_for('static', filename='logos/' + folder.logo_filename) }}" style="max-height: 80px; max-width: 100%; object-fit: contain;" alt="{{ folder.name }} logo">
                                {% else %}
                                <i class="fas fa-cube fa-3x text-muted"></i>
                                {% endif %}
                            </div>
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1 text-dark text-truncate" title="{{ folder.name }}">{{ folder.name }}</h6>
                            </div>
                            <div class="card-footer bg-transparent border-0 pt-0 pb-2">
                                <small class="text-muted text-truncate d-block" title="{{ folder.description }}">{{ folder.description or ' ' }}</small>
                            </div>
                        </div>
                    </a>
                </div>

            {% endfor %}
            
            {# 循环结束后，不要忘记闭合最后一个分组的卡片容器div #}
            </div>

        {% else %}
            <!-- 如果没有任何文件夹 -->
            <div class="col-12">
                <h3 class="mb-4"><i class="fas fa-cubes me-2"></i>镜像列表</h3>
                <p class="text-center text-muted py-5">暂无任何文件夹</p>
            </div>
        {% endif %}
    </div>

    <!-- 侧边栏：仅保留公告、统计信息、服务器状态，其余全部删除 -->
    <div class="col-lg-4">
        <div class="sticky-top" style="top: 1.5rem;">
            <!-- 公告 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header"><i class="fas fa-bullhorn me-2"></i>新闻公告</div>
                <ul class="list-group list-group-flush small">
                    {% for item in site_settings.announcements %}
                    <li class="list-group-item"><strong>{{ item.date }}:</strong> {{ item.text }}</li>
                    {% else %}
                    <li class="list-group-item text-muted">暂无公告</li>
                    {% endfor %}
                </ul>
            </div>
            <!-- 统计信息 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header"><i class="fas fa-chart-line me-2"></i>站点统计</div>
                <ul class="list-group list-group-flush small">
                    <li class="list-group-item d-flex justify-content-between"><span>文件夹总量:</span> <strong>{{ stats.folder_count }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>全站文件量:</span> <strong>{{ stats.file_count }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>最近上传:</span> <strong>{{ stats.last_upload_formatted or '暂无' }}</strong></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 引入 Socket.IO 客户端库 -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // 连接到后端的 Socket.IO 服务器
    const socket = io();

    // 1. 当成功连接时
    socket.on('connect', function() {
        console.log('成功连接到服务器!');
        // 立即请求一次系统状态数据
        socket.emit('request_system_stats');
    });

    // 2. 监听从服务器发来的 'system_stats_update' 事件
    socket.on('system_stats_update', function(stats) {
        // console.log('收到服务器状态更新:', stats);
        const cpuElement = document.getElementById('cpu-percent');
        const memElement = document.getElementById('memory-percent');
        const timeElement = document.getElementById('server-time');

        if (cpuElement) {
            cpuElement.textContent = stats.cpu_percent.toFixed(1) + '%';
        }
        if (memElement) {
            memElement.textContent = stats.memory_percent.toFixed(1) + '%';
        }
        if (timeElement) {
            timeElement.textContent = stats.server_time;
        }
    });

    // 3. 设置一个定时器，每隔5秒钟向服务器请求一次最新状态
    //    这会触发后端 handle_system_stats_request 函数
    setInterval(function() {
        if (socket.connected) {
            socket.emit('request_system_stats');
        }
    }, 5000); // 5000毫秒 = 5秒

    // 当断开连接时的处理（可选）
    socket.on('disconnect', function() {
        console.log('与服务器断开连接。');
        document.getElementById('cpu-percent').textContent = '已断开';
        document.getElementById('memory-percent').textContent = '已断开';
        document.getElementById('server-time').textContent = '已断开';
    });
});
</script>
{% endblock %}
